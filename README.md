# 都市気温・地中温度シミュレーション

## 概要
本プログラムは、都市の地表面・地中温度および都市気温の時系列変化を、気象データ（日射・大気放射）をもとに差分法と熱収支モデルで計算・可視化するPythonスクリプトです。ヒートアイランド現象や都市環境の熱的影響評価、人工排熱や蒸発効率の効果検証などに利用できます。

---

## 使い方
1. 必要なPythonライブラリをインストール
   ```bash
   pip install -r requirements.txt
   ```
2. 入力データ（`data/夏の全天日射量と大気放射量.csv`、`data/冬の全天日射量と大気放射量.csv`）を用意
3. `calcUrbanTemperature.py` を実行
   ```bash
   python calcUrbanTemperature.py
   ```
4. 結果（CSV・グラフ画像）が同じフォルダに出力されます

---

## 計算条件
- シミュレーション期間：7日間（0.5時間刻み、最初の6日間は助走、最後の1日間を分析）
- 季節：夏または冬（`SEASON`で切替）
- 蒸発効率：`BETA`（0～1）
- 人工排熱量：`Q_H`（W/m2）
- 地盤熱伝導率：1.1 W/m2K
- 地盤比熱：1.6×10^6 J/m3K
- 地下深度：1.0m（10cm刻み）
- 地下下端温度：夏26℃、冬10℃
- 入力データ：24時間分を7日間繰り返し使用

---

## 入力データの解説
- `data/夏の全天日射量と大気放射量.csv`、`data/冬の全天日射量と大気放射量.csv`
  - 列：時間経過(h), 全天日射量(W/m2), 大気放射量(W/m2)
  - 0.5時間刻み、24時間分
- プログラムは自動で7日間分に拡張して使用

---

## 計算で扱う数式・計算順序


### 1. 大気温度（上空気温）
**式:**
  - 1式:
    $$
    \Gamma(t) = 0.44 - 0.46 \sin(\omega t + 0.9) + 0.11 \sin(2\omega t + 0.9)
    $$
  - 2式:
    $$
    T_a = T_x \Gamma(t) + T_n (1-\Gamma(t))
    $$
    - $T_x$：最高気温 [℃]
    - $T_n$：最低気温 [℃]
    - $\omega = 2\pi/24$ [1/h]
**解説:**
指定した最高気温・最低気温と時刻から、1日周期の大気温度（上空気温）を計算します。単位は[℃]です。
1式は、24時間の気温変化を0~1の範囲で表現するフーリエ級数です。


### 2. 大気安定度・非断熱補正係数
**式:**
  - 大気安定度
    $$
    \zeta = -\frac{\kappa g H \cdot H}{\hat{\rho} c_p (T_a + 273.15) u_*^3}
    $$
    - $\kappa$：カルマン定数 [-]
    - $g$：重力加速度 [m/s^2]
    - $H$：高さ [m]
    - $H$：顕熱フラックス [W/m^2]
    - $\hat{\rho}$：大気の密度 [mol/m^3]
    - $c_p$：空気の比熱 [J/(mol\cdot K)]
    - $T_a$：大気温度 [℃]
    - $u_*$：摩擦速度 [m/s]
  - 非断熱補正係数（安定・中立・不安定で分岐）
    - 安定時: $\psi_M = \psi_H = 6 \ln(1 + \zeta)$
    - 中立時: $\psi_M = \psi_H = 0$
    - 不安定時: $\psi_H = -2 \ln\left(\frac{1 + \sqrt{1 - 16\zeta}}{2}\right),\ \psi_M = 0.6\psi_H$
**解説:**
大気の安定度（乱流の発生しやすさ）を示す無次元量と、乱流輸送の補正係数を計算します。単位は$\zeta$が無次元、$\psi_M, \psi_H$も無次元です。


### 3. 摩擦速度
**式:**
  $$
  u_* = \frac{\kappa U_{100}}{\ln((H-D)/z_M) + \psi_M}
  $$
  - $U_{100}$：高さ100mでの風速 [m/s]
  - $D$：零面変位 [m]
  - $z_M$：運動量粗度 [m]
  - $\psi_M$：非断熱補正係数
**解説:**
地表面付近の乱流強度を表す摩擦速度を計算します。単位は[m/s]です。


### 4. 都市境界層コンダクタンス・表層熱コンダクタンス
**式:**
  - 都市境界層コンダクタンス:
    $$
    g_{Ha} = \frac{\kappa^2 \hat{\rho} U_{100}}{(\ln((H-D)/z_M)+\psi_M)(\ln((H-D)/z_H)+\psi_H)}
    $$
  - 表層熱コンダクタンス:
    $$
    g_{Has} = \frac{a_s}{c_p}
    $$
    - $a_s$：表層対流熱伝達率 [W/(m^2 K)]
**解説:**
都市境界層および地表面の熱輸送効率を示すコンダクタンス（伝達率）を計算します。単位は[mol/(m^2 s)]です。


### 5. 地表面温度（熱収支式）
**式:**
  $$
  T_s^{\mathrm{new}} = T_s^{\mathrm{prev}} + \frac{\Delta t \cdot 3600}{C_1} \left[ a_s (T_a - T_s^{\mathrm{prev}}) - \lambda (T_s^{\mathrm{prev}} - T_{\mathrm{underground}}) + R_n - lE + Q_H \right]
  $$
    - $T_s$：地表面温度 [℃]
    - $\Delta t$：時間刻み [h]
    - $C_1$：地表の熱容量 [J/(m^2 K)]
    - $\lambda$：地盤熱伝導率 [W/(m^2 K)]
    - $T_{underground}$：前時刻の第１層目の地下温度 [℃]
    - $R_n$：正味放射 [W/m^2]
    - $lE$：潜熱フラックス [W/m^2]
    - $Q_H$：人工排熱 [W/m^2]
**解説:**
地表面温度は、入射日射・大気放射・地中からの熱伝導・蒸発・人工排熱など、地表面でのエネルギー収支が釣り合うように計算します。熱収支の考え方に基づき、地表面の温度変化を逐次的に求めます。単位は[℃]です。
3600は 3600 s/h で、単位を合わせる必要があるので掛けています。
計算に用いる温度はすべて、1時刻前の気温を用いて算出しています。


### 6. 地中温度（差分法）
**式:**
  $$
  T_i^{\mathrm{new}} = T_i + \alpha (T_{i-1} + T_{i+1} - 2T_i)
  $$
    - $T_i$：地下i層目の温度 [℃]
    - $\alpha = \frac{\lambda \cdot 3600 \cdot \Delta t}{C_\Gamma \Delta x^2}$：熱拡散率 [無次元]
    - $C_\Gamma$：地盤比熱 [J/(m^3 K)]
    - $\Delta x$：深さ刻み [m]
**解説:**
地中温度は、熱伝導方程式を差分法で離散化し、各層間の熱のやりとりを計算します。これにより、地中深くまでの温度分布や時間変化を再現します。単位は[℃]です。


### 7. 飽和水蒸気圧（Tetensの式）
**式:**
  $$
  e_s = 6.11 \times 10^{7.5 T / (T + 237.3)}
  $$
    - $T$：温度 [℃]
**解説:**
地表面温度から飽和水蒸気圧を求めます。単位は[hPa]です。


### 8. 潜熱フラックス
**式:**
  $$
  lE = L_v \cdot \beta \cdot \alpha_w (e_s \times 100 - E_a)
  $$
    - $L_v$：蒸発潜熱 [J/kg]
    - $\beta$：蒸発効率 [-]
    - $\alpha_w$：湿気伝達率 [kg/(m^2\,\mathrm{s}\,\mathrm{Pa})]
    - $e_s$：飽和水蒸気圧 [hPa]
    - $E_a$：大気の水蒸気圧 [Pa]
**解説:**
潜熱フラックスは、地表面からの蒸発による熱の損失量です。地表面の飽和水蒸気圧と大気中の水蒸気圧の差、蒸発効率、伝達率などから計算します。単位は[W/m^2]です。


### 9. 顕熱フラックス
**式:**
  $$
  H = \frac{T_s - T_a}{R_s + R_u}
  $$
    - $R_s = 1/a_s$：表面熱伝達抵抗 [K\,m^2/W]
    - $R_u = 1/a_u$：都市境界層熱抵抗 [K\,m^2/W]
**解説:**
顕熱フラックスは、地表面と大気の温度差による熱の輸送量です。熱伝達抵抗を介して、温度差が大きいほど熱の移動量も大きくなります。
回路で用いられるオームの法則を熱輸送にあてはめたような考え方です。
顕熱フラックスが流れる電流I、熱抵抗が抵抗R、気温変化が電圧Vのようにイメージするとわかりやすいです。
単位は[W/m^2]です。


### 10. 都市気温
**式:**
  $$
  T_u = \frac{a_s T_s + a_u T_a}{a_s + a_u}
  $$
    - $a_s = g_{Has} c_p$：表層熱伝達率 [W/(m^2 K)]
    - $a_u = g_{Ha} c_p$：都市境界層熱伝達率 [W/(m^2 K)]
**解説:**
地表面温度と大気温度から、都市の代表的な気温（都市気温）を計算します。単位は[℃]です。


---

## 出力
- `urban_temperature_simulation.csv`：全時刻の計算結果
- `urban_temperature_simulation.png`：7日間の都市気温・地表面温度・上空気温の推移
- `urban_temperature_simulation_last_24_hours.png`：最後の24時間の推移

---

